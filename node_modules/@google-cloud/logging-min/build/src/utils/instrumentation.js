"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.resetInstrumentationStatus=exports.getNodejsLibraryVersion=exports.createDiagnosticEntry=exports.populateInstrumentationInfo=exports.getInstrumentationInfoStatus=exports.NODEJS_LIBRARY_NAME_PREFIX=exports.INSTRUMENTATION_SOURCE_KEY=exports.DIAGNOSTIC_INFO_KEY=void 0;const arrify=require("arrify");const path=require("path");const protos_1=require("../../protos/protos");const entry_1=require("../entry");global.instrumentationAdded=false;let libraryVersion;const maxDiagnosticValueLen=14;exports.DIAGNOSTIC_INFO_KEY="logging.googleapis.com/diagnostic";exports.INSTRUMENTATION_SOURCE_KEY="instrumentation_source";exports.NODEJS_LIBRARY_NAME_PREFIX="nodejs";function getInstrumentationInfoStatus(){return global.instrumentationAdded}exports.getInstrumentationInfoStatus=getInstrumentationInfoStatus;function populateInstrumentationInfo(entry){var _a,_b;let isWritten=global.instrumentationAdded;global.instrumentationAdded=true;const entries=[];if(entry){for(const entryItem of arrify(entry)){if(entryItem){const info=(_b=(_a=entryItem.data)===null||_a===void 0?void 0:_a[exports.DIAGNOSTIC_INFO_KEY])===null||_b===void 0?void 0:_b[exports.INSTRUMENTATION_SOURCE_KEY];if(info){entryItem.data[exports.DIAGNOSTIC_INFO_KEY][exports.INSTRUMENTATION_SOURCE_KEY]=validateAndUpdateInstrumentation(info);isWritten=true}entries.push(entryItem)}}}if(!isWritten){entries.push(createDiagnosticEntry(undefined,undefined))}return entries}exports.populateInstrumentationInfo=populateInstrumentationInfo;function createDiagnosticEntry(libraryName,libraryVersion){if(!libraryName||!libraryName.startsWith(exports.NODEJS_LIBRARY_NAME_PREFIX)){libraryName=exports.NODEJS_LIBRARY_NAME_PREFIX}const entry=new entry_1.Entry({severity:protos_1.google.logging.type.LogSeverity.INFO},{[exports.DIAGNOSTIC_INFO_KEY]:{[exports.INSTRUMENTATION_SOURCE_KEY]:[{name:truncateValue(libraryName,maxDiagnosticValueLen),version:truncateValue(libraryVersion!==null&&libraryVersion!==void 0?libraryVersion:getNodejsLibraryVersion(),maxDiagnosticValueLen)}]}});return entry}exports.createDiagnosticEntry=createDiagnosticEntry;function validateAndUpdateInstrumentation(infoList){const finalInfo=[];finalInfo.push({name:exports.NODEJS_LIBRARY_NAME_PREFIX,version:getNodejsLibraryVersion()});let count=1;for(const info of infoList){if(isValidInfo(info)){finalInfo.push({name:truncateValue(info.name,maxDiagnosticValueLen),version:truncateValue(info.version,maxDiagnosticValueLen)})}if(++count===3)break}return finalInfo}function truncateValue(value,maxLen){if(value&&value.length>maxLen){return value.substring(0,maxLen).concat("*")}return value}function getNodejsLibraryVersion(){if(libraryVersion){return libraryVersion}libraryVersion=require(path.resolve(__dirname,"../../../","package.json")).version;return libraryVersion}exports.getNodejsLibraryVersion=getNodejsLibraryVersion;function isValidInfo(info){if(!info||!info.name||!info.version||!info.name.startsWith(exports.NODEJS_LIBRARY_NAME_PREFIX)){return false}return true}function resetInstrumentationStatus(){global.instrumentationAdded=false}exports.resetInstrumentationStatus=resetInstrumentationStatus;
//# sourceMappingURL=instrumentation.js.map